<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Опросник с монетами — Организатор и Участник</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>
  <style>
    :root {
      --bg: #0f123d;
      --text: #e0e0e0;
      --accent: #6c5ce7;
      --accent2: #00b894;
      --danger: #d63031;
      --light: #ffffff33;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial; color: var(--text); background: radial-gradient(1200px 600px at 10% -10%, #1c2147, transparent 60%), radial-gradient(1000px 500px at 120% 0%, #1a2b4f, transparent 55%), var(--bg); letter-spacing: .2px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    button { background: var(--accent); color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
    button:hover { opacity: 0.9; }
    input, select { padding: 6px 10px; border-radius: 4px; border: 1px solid #555; background: #111; color: #eee; }
    h1,h2,h3,h4,h5,h6 { margin: 0 0 12px 0; }
    .tabs { display: flex; gap: 12px; margin-bottom: 24px; }
    .tab { padding: 6px 12px; background: #222; border-radius: 6px; cursor: pointer; }
    .tab.active { background: var(--accent); }
    .panel { display: none; }
    .panel.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 6px 10px; border: 1px solid #555; text-align: left; }
    canvas { background: #111; border-radius: 8px; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Опросник с монетами</h1>
    <div class="tabs">
      <div class="tab active" data-panel="organizer">Организатор</div>
      <div class="tab" data-panel="voter">Участник</div>
      <div class="tab" data-panel="screen">Экран</div>
    </div>

    <div id="organizer" class="panel active">
      <button id="newPollBtn">Создать новый опрос</button>
      <div id="pollInfo"></div>
      <div id="optionsContainer"></div>
      <canvas id="chart" width="400" height="200"></canvas>
      <table id="resultsTable">
        <thead><tr><th>Вариант</th><th>Монеты</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="voter" class="panel">
      <input type="text" id="pollCodeInput" placeholder="Код опроса">
      <button id="joinPollBtn">Присоединиться</button>
      <div id="voterInterface"></div>
    </div>

    <div id="screen" class="panel">
      <canvas id="screenChart" width="600" height="300"></canvas>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const randCode = () => 'V-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    // Инициализация Gun.js (локальный сервер)
    let gun = Gun({ peers: [window.location.origin + '/gun'] });
    let user = gun.user().recall({ sessionStorage: true });

    let current = { poll: null, chart: null, screenChart: null };

    function refreshInfo() {
      if (!current.poll) return;
      $('#pollInfo').innerHTML = `<p>ID: ${current.poll.id}, Код: ${current.poll.code}</p>`;
    }

    function newPoll() {
      const id = uid();
      const code = randCode();
      const poll = { id, code, options: [], voters: {}, allocations: {} };
      current.poll = poll;
      savePollToGun();
      renderOptions();
      refreshInfo();
      drawAll();
    }

    function savePollToGun() {
      gun.get('polls').get(current.poll.id).put(current.poll);
    }

    function loadPollFromGun(id, callback) {
      gun.get('polls').get(id).once(data => {
        current.poll = data;
        callback && callback(data);
      });
    }

    function subscribeToPollUpdates(id) {
      gun.get('polls').get(id).on(data => {
        current.poll = data;
        renderOptions();
        drawAll();
      });
    }

    function renderOptions() {
      if (!current.poll) return;
      const container = $('#optionsContainer');
      container.innerHTML = '';
      current.poll.options.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = opt;
        container.appendChild(div);
      });
    }

    function tally() {
      if (!current.poll) return {};
      let result = {};
      current.poll.options.forEach(opt => result[opt] = 0);
      Object.values(current.poll.allocations || {}).forEach(alloc => {
        Object.entries(alloc).forEach(([opt,val])=>{
          result[opt] += val;
        });
      });
      return result;
    }

    function drawAll() { drawChart('#chart'); drawScreen(); fillResultsTable(); }

    function drawChart(sel) {
      const ctx = $(sel).getContext('2d');
      const data = tally();
      if(current.chart) current.chart.destroy();
      current.chart = new Chart(ctx, { type:'bar', data:{labels:Object.keys(data), datasets:[{label:'Монеты', data:Object.values(data), backgroundColor:'rgba(108,92,231,0.7)'}] }, options:{responsive:true, plugins:{legend:{display:false}}}});
    }

    function fillResultsTable() {
      const tbody = $('#resultsTable tbody');
      tbody.innerHTML = '';
      const data = tally();
      for (let opt in data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${opt}</td><td>${data[opt]}</td>`;
        tbody.appendChild(tr);
      }
    }

    // Вкладка участника
    let vState = { code: null, pollId: null, budget: 10, allocations: {} };

    function joinByCode(code) {
      gun.get('polls').map().once(poll=>{
        if(poll.code===code){
          vState.pollId = poll.id;
          subscribeToPollUpdates(poll.id);
          renderVoterInterface();
        }
      });
    }

    function renderVoterInterface() {
      const container = $('#voterInterface');
      if(!current.poll) { container.innerHTML = 'Опрос не найден'; return; }
      container.innerHTML = '';
      current.poll.options.forEach(opt=>{
        const input = document.createElement('input');
        input.type='number'; input.min=0; input.value=vState.allocations[opt]||0;
        input.oninput = e=>{ vState.allocations[opt]=parseInt(e.target.value)||0; };
        const label = document.createElement('label');
        label.textContent = opt+': '; label.appendChild(input);
        container.appendChild(label); container.appendChild(document.createElement('br'));
      });
      const submitBtn = document.createElement('button');
      submitBtn.textContent='Голосовать';
      submitBtn.onclick = ()=>{ submitVote(); };
      container.appendChild(submitBtn);
    }

    function submitVote(){
      if(!current.poll || !vState.pollId) return;
      gun.get('polls').get(vState.pollId).get('allocations').get(uid()).put(vState.allocations);
      alert('Голос отправлен!');
    }

    function drawScreen() {
      const ctx = $('#screenChart').getContext('2d');
      const data = tally();
      if(current.screenChart) current.screenChart.destroy();
      current.screenChart = new Chart(ctx, { type:'bar', data:{labels:Object.keys(data), datasets:[{label:'Монеты', data:Object.values(data), backgroundColor:'rgba(0,184,148,0.7)'}] }, options:{responsive:true, plugins:{legend:{display:false}}}});
    }

    // Переключение вкладок
    $$('.tab').forEach(tab=>{
      tab.onclick=()=>{ showPanel(tab.dataset.panel); };
    });

    function showPanel(name){
      $$('.panel').forEach(p=>p.classList.remove('active'));
      $$('.tab').forEach(t=>t.classList.remove('active'));
      $(`#${name}`).classList.add('active');
      $$(`.tab[data-panel="${name}"]`).forEach(t=>t.classList.add('active'));
    }

    // События кнопок
    $('#newPollBtn').onclick = ()=>{ newPoll(); };
    $('#joinPollBtn').onclick = ()=>{ joinByCode($('#pollCodeInput').value); };

  </script>
</body>
</html>
